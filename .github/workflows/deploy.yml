name: Deploy

on:
  push:
    branches: [main, master]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Build
        run: |
          npm ci

          # Create production environment file
          echo "VITE_LOG_ENDPOINT=http://${{ secrets.SSH_HOST }}/api/log" > .env.production
          echo "VITE_APP_ENV=production" >> .env.production

          # Copy IPINFO_TOKEN from secrets if available
          if [ -n "${{ secrets.IPINFO_TOKEN }}" ]; then
            echo "VITE_IPINFO_TOKEN=${{ secrets.IPINFO_TOKEN }}" >> .env.production
          fi

          npm run build
          
      - name: Deploy
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          echo "Deploying to host: $SSH_HOST"
          
          # Frontend
          rsync -avz --delete -e "ssh -o StrictHostKeyChecking=no" \
            dist/ root@$SSH_HOST:/var/www/html/
            
          # Backend - Copy server files
          rsync -avz --delete -e "ssh -o StrictHostKeyChecking=no" \
            server/ root@$SSH_HOST:/var/maf-guides/server/

          # Backend - Build and restart
          ssh -o StrictHostKeyChecking=no root@$SSH_HOST "
            # Ensure directory exists
            mkdir -p /var/maf-guides/server

            # Check if Go is installed
            if ! command -v go &> /dev/null; then
              echo 'Go is not installed. Installing...'
              apt-get update
              apt-get install -y golang
            fi

            # Build Go server
            cd /var/maf-guides/server
            go build -o logserver
            chmod +x logserver

            # Check if systemd service exists, create if not
            if [ ! -f /etc/systemd/system/logserver.service ]; then
              echo 'Creating systemd service...'
              echo '[Unit]' > /tmp/logserver.service
              echo 'Description=Log Server for Maf Guides' >> /tmp/logserver.service
              echo 'After=network.target' >> /tmp/logserver.service
              echo '' >> /tmp/logserver.service
              echo '[Service]' >> /tmp/logserver.service
              echo 'Type=simple' >> /tmp/logserver.service
              echo 'User=root' >> /tmp/logserver.service
              echo 'Group=root' >> /tmp/logserver.service
              echo 'WorkingDirectory=/var/maf-guides/server' >> /tmp/logserver.service
              echo 'ExecStart=/var/maf-guides/server/logserver' >> /tmp/logserver.service
              echo 'Restart=always' >> /tmp/logserver.service
              echo 'RestartSec=10' >> /tmp/logserver.service
              echo 'Environment=PORT=3002' >> /tmp/logserver.service
              echo '' >> /tmp/logserver.service
              echo '[Install]' >> /tmp/logserver.service
              echo 'WantedBy=multi-user.target' >> /tmp/logserver.service
              mv /tmp/logserver.service /etc/systemd/system/logserver.service
              systemctl daemon-reload
              systemctl enable logserver
            fi

            # Restart service
            systemctl restart logserver
            systemctl status logserver
          "